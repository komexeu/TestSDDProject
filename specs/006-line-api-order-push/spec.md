

# 功能規格說明書：LINE 訂單狀態推播 API

**說明**：本範本由 `/speckit.spec` 指令自動產生。

**功能分支**：`006-line-api-order-push`
**建立日期**：2025-11-14
**狀態**：草稿
**輸入描述**：「我要建立幾個line api\n提供訂單狀態轉換時呼叫推播\n分為主動推播跟被動推播」

## 使用者情境與測試（必填）

### 使用者故事 1 - 訂單狀態主動推播（優先順序：P1）

當訂單狀態發生變更時，系統自動透過 LINE API 主動推播訊息給用戶，通知其訂單最新狀態。

**優先原因**：即時通知用戶訂單狀態，提升用戶體驗與資訊透明度。

**獨立測試方式**：模擬訂單狀態變更，驗證用戶能即時收到 LINE 推播通知。

**驗收情境**：
1. **前提**：用戶有綁定 LINE，訂單狀態為「處理中」，**當**狀態變更為「已出貨」，**則**用戶收到「您的訂單已出貨」LINE 訊息。
2. **前提**：用戶有綁定 LINE，訂單狀態為「已出貨」，**當**狀態變更為「已完成」，**則**用戶收到「您的訂單已完成」LINE 訊息。

---


### 使用者故事 2 - 訂單狀態被動推播（優先順序：P2）

用戶必須先完成 LINE 綁定，才可於 LINE 聊天視窗輸入查詢指令並獲得訂單狀態回應。

**優先原因**：確保資訊安全與正確性，用戶可隨時查詢訂單進度，提升互動性與自主性。

**獨立測試方式**：用戶於 LINE 輸入查詢指令，系統先檢查綁定狀態，已綁定者正確回覆訂單狀態，未綁定者提示需先綁定。

**驗收情境**：
1. **前提**：用戶有綁定 LINE，**當**輸入「查詢訂單」指令，**則**系統回覆目前訂單狀態。
2. **前提**：用戶未綁定 LINE，**當**輸入「查詢訂單」指令，**則**系統提示需先綁定。

---

### 使用者故事 3 - 未綁定 LINE 用戶（優先順序：P3）

未綁定 LINE 的用戶在訂單狀態變更時不會收到推播，查詢時系統提示需先綁定。

**優先原因**：避免推播失敗，並引導用戶完成綁定。

**獨立測試方式**：模擬未綁定用戶，驗證推播不發送且查詢時有提示。

**驗收情境**：
1. **前提**：用戶未綁定 LINE，**當**訂單狀態變更，**則**不發送推播。
2. **前提**：用戶未綁定 LINE，**當**查詢訂單，**則**系統提示需先綁定。

---

### Edge Cases

- 訂單狀態異常（如不存在的狀態、異常、製作失敗）時，系統如何處理？
	- 例如：狀態為「異常」或「製作失敗」時，推播內容需明確通知用戶並建議後續處理。
- LINE API 回應失敗時，如何重試或記錄？
- 用戶同時有多筆訂單時，推播內容如何區分？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統 MUST 於訂單狀態變更時，主動推播 LINE 訊息給已綁定用戶。
- **FR-002**: 系統 MUST 提供 LINE 被動查詢 API，僅允許已綁定用戶查詢訂單狀態，未綁定者須先完成綁定。
- **FR-003**: 系統 MUST 檢查用戶是否已綁定 LINE，未綁定時不發送推播並提示。
- **FR-004**: 系統 MUST 處理 LINE API 回應失敗，並記錄錯誤與重試機制。
- **FR-005**: 系統 MUST 支援多筆訂單推播內容區分。

### Key Entities *(include if feature involves data)*

- **訂單（Order）**：包含訂單編號、狀態、用戶 ID、商品明細等。
- **訂單狀態（OrderStatus）**：
	- 已點餐
	- 已確認訂單
	- 製作中
	- 可取餐
	- 已取餐完成
	- 已取消
	- 製作失敗
	- 異常
- **用戶（User）**：包含用戶 ID、LINE 綁定資訊。
- **推播紀錄（PushLog）**：紀錄推播內容、狀態、時間、失敗原因等。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 90% 以上訂單狀態變更可於 10 秒內完成推播。
- **SC-002**: 95% 以上用戶查詢訂單時可正確獲得狀態回覆。
- **SC-003**: 未綁定 LINE 用戶推播失敗率為 0，且查詢時皆有提示。
- **SC-004**: 推播失敗皆有記錄，且 80% 以上可於 1 分鐘內自動重試成功。

### Assumptions

- 用戶必須先完成 LINE 綁定流程，否則無法使用主動或被動推播功能。
- 訂單狀態變更由後台或自動流程觸發。
- LINE API 金鑰與頻率限制已妥善管理。

